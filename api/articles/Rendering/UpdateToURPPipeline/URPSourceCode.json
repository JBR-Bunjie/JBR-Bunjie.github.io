{"title":"URP源码分析","uid":"23661fa8ae25c981d575d8f076eed3e1","slug":"Rendering/UpdateToURPPipeline/URPSourceCode","date":"2023-04-08T13:32:05.000Z","updated":"2023-10-27T20:19:19.000Z","comments":true,"path":"api/articles/Rendering/UpdateToURPPipeline/URPSourceCode.json","keywords":null,"cover":"https://raw.githubusercontent.com/JBR-Bunjie/JBR-Bunjie/main/back.jpg","content":"<h1 id=\"urp源码分析\">URP源码分析</h1>\r\n<h2 id=\"依赖信息\">依赖信息：</h2>\r\n<ul>\r\n<li>Editor版本：2021.21f1 LTS</li>\r\n<li>Shader版本：URP 12.1.10</li>\r\n</ul>\r\n<h2 id=\"urp-package总览\">URP Package总览</h2>\r\n<p>首先，当我们下载URP资源时，我们的项目的Package中会出现这些内容：</p>\r\n<p><img\r\nsrc=\"......\\images\\Dev\\Unity\\SourceCodeAnalysis\\URPSourceCode\\001.png\"\r\nalt=\"image-20230408215042373\" /> <em>URP资源结构 -\r\ncom.unity.render-pipelines.universal Part</em></p>\r\n<p><img\r\nsrc=\"......\\images\\Dev\\Unity\\SourceCodeAnalysis\\URPSourceCode\\002.png\"\r\nalt=\"image-20230408215738417\" /> <em>URP资源结构 -\r\ncom.unity.render-pipelines.core Part</em></p>\r\n<p>这两个Library一起，组成了我们的URP资源，这也是我们在实际使用时引入资源的两个对应的实际位置：</p>\r\n<pre class=\"line-numbers language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\">#include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Core.hlsl&quot;\n#include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl&quot;</code></pre>\r\n<p>由于这两个Package实际上是互相引用的，所以我们就先就着\r\n<code>Universal RP</code> 来展开：</p>\r\n<ul>\r\n<li>Documentation的包含了大量的说明文档，这些都是帮助我们理解URP资源的好资料。这些内容和官方网站上是完全一致的，所以也没必要就着这里面看——<a\r\nhref=\"https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@12.1/manual/index.html\">Universal\r\nRender Pipeline overview | Universal RP | 12.1.10 (unity3d.com)</a></li>\r\n<li>Editor</li>\r\n<li>Runtime：</li>\r\n<li>Samples：示例文件、资源及工程</li>\r\n<li><strong>ShaderLibrary</strong></li>\r\n<li><strong>Shaders</strong></li>\r\n<li>Tests</li>\r\n<li>Textures</li>\r\n</ul>\r\n<h2 id=\"从core.hlsl开始\">从Core.hlsl开始</h2>\r\n<p>这是我们最早接触的一个hlsl文件。</p>\r\n<p>总的来说，这个文件做了这么三件事：</p>\r\n<ul>\r\n<li></li>\r\n</ul>\r\n<h3 id=\"分析\">分析</h3>\r\n<h4 id=\"及196\">1~2及196</h4>\r\n<p>第1~2行与第196行是防止重复引用的判断语句。</p>\r\n<h4 id=\"section\">4~6</h4>\r\n<p>之后的4~5行是注释：</p>\r\n<blockquote>\r\n<p>// <em>VT is not supported in URP (for now) this ensures any shaders\r\nusing the VT</em> // <em>node work by falling to regular texture\r\nsampling.</em></p>\r\n</blockquote>\r\n<p>并在第6行做了定义：#define FORCE_VIRTUAL_TEXTURING_OFF 1</p>\r\n<p>快速而全面地了解VT，可以看:</p>\r\n<ul>\r\n<li><a\r\nhref=\"https://docs.unity3d.com/2020.1/Documentation/Manual/svt-marking-textures.html\">Unity\r\n- Manual: Marking textures as \"Virtual Texturing Only\"\r\n(unity3d.com)</a></li>\r\n<li><a\r\nhref=\"https://forum.unity.com/threads/feedback-wanted-streaming-virtual-texturing.849133/#:~:text=Streaming%20Virtual%20Texturing%20is%20a%20texture%20streaming%20feature,tiles%20to%20GPU%20memory%20when%20they%20are%20needed.\">Official\r\n- Feedback Wanted: Streaming Virtual Texturing - Unity Forum</a></li>\r\n</ul>\r\n<blockquote>\r\n<p>Streaming Virtual Texturing is a texture streaming feature that\r\nreduces GPU memory usage and Texture loading times when you have many\r\nhigh resolution Textures in your scene. It works by splitting Textures\r\ninto tiles, and progressively uploading these tiles to GPU memory when\r\nthey are needed.</p>\r\n</blockquote>\r\n<h4 id=\"section-1\">8~14</h4>\r\n<p>第8~14行，我们定义的是集群渲染，这个在过去文档中有过相关描述，论坛中也有相关讨论\r\n<a\r\nhref=\"https://docs.unity3d.com/560/Documentation/Manual/ClusterRendering.html\">Unity\r\n- Manual: Cluster Rendering (unity3d.com)</a> <a\r\nhref=\"https://forum.unity.com/threads/any-info-on-experimental-urp-12-clustered-rendering-option.1238071/\">Any\r\ninfo on experimental URP 12 clustered rendering option? - Unity\r\nForum</a></p>\r\n<h4 id=\"section-2\">16~19</h4>\r\n<p>引入了四个外部文件，来自core和universal两个位置。这些内容主要做了这些事：</p>\r\n<ul>\r\n<li></li>\r\n</ul>\r\n<pre class=\"line-numbers language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\">#include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Common.hlsl&quot;\n#include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Packing.hlsl&quot;\n#include &quot;Packages&#x2F;com.unity.render-pipelines.core&#x2F;ShaderLibrary&#x2F;Version.hlsl&quot;\n#include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Input.hlsl&quot;</code></pre>\r\n<h4 id=\"section-3\">21~46</h4>\r\n<p>21~27行检查并定义了宏\r\n<code>SHADER_HINT_NICE_QUALITY</code>，如未定义则默认基于可能存在的移动平台宏\r\n<code>SHADER_API_MOBILE</code> 和Switch <code>SHADER_API_SWITCH</code>\r\n设为0，其他为1。 <a\r\nhref=\"https://blog.csdn.net/kan464872327/article/details/108618500\">ShaderLibrary\r\n- DefineSysmbols_装大炮的自行车的博客-CSDN博客</a></p>\r\n<p>这之后的29~42行，则根据 <code>SHADER_HINT_NICE_QUALITY</code>\r\n及实际调用的API输出分别输出 <code>SHADER_QUALITY_HIGH</code>,\r\n<code>SHADER_QUALITY_MEDIUM</code>,\r\n<code>SHADER_QUALITY_LOW</code>三个宏之一</p>\r\n<blockquote>\r\n<p>// Shader Quality Tiers in Universal. // SRP doesn't use Graphics\r\nSettings Quality Tiers. // We should expose shader quality tiers in the\r\npipeline asset.</p>\r\n<p>// Meanwhile, it's forced to be: // High Quality: Non-mobile\r\nplatforms or shader explicit defined\r\n<code>SHADER_HINT_NICE_QUALITY</code> // Medium: Mobile aside from GLES2\r\n// Low: GLES2</p>\r\n</blockquote>\r\n<p>然后在44~46行对 <code>SHADER_HINT_NICE_QUALITY</code> 取反得到宏\r\n<code>BUMP_SCALE_NOT_SUPPORTED</code></p>\r\n<h4 id=\"section-4\">49~65</h4>\r\n<p>根据具体的平台使用(主要是 <code>UNITY_REVERSED_Z</code> 和\r\n<code>UNITY_UV_STARTS_AT_TOP</code>\r\n宏)，UNITY做了关于裁剪空间的兼容性处理，内容如下：</p>\r\n<pre class=\"line-numbers language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\">#if UNITY_REVERSED_Z\n    &#x2F;&#x2F; TODO: workaround. There&#39;s a bug where SHADER_API_GL_CORE gets erroneously defined on switch.\n    #if (defined(SHADER_API_GLCORE) &amp;&amp; !defined(SHADER_API_SWITCH)) || defined(SHADER_API_GLES) || defined(SHADER_API_GLES3)\n        &#x2F;&#x2F;GL with reversed z &#x3D;&gt; z clip range is [near, -far] -&gt; remapping to [0, far]\n        #define UNITY_Z_0_FAR_FROM_CLIPSPACE(coord) max((coord - _ProjectionParams.y)&#x2F;(-_ProjectionParams.z-_ProjectionParams.y)*_ProjectionParams.z, 0)\n    #else\n        &#x2F;&#x2F;D3d with reversed Z &#x3D;&gt; z clip range is [near, 0] -&gt; remapping to [0, far]\n        &#x2F;&#x2F;max is required to protect ourselves from near plane not being correct&#x2F;meaningful in case of oblique matrices.\n        #define UNITY_Z_0_FAR_FROM_CLIPSPACE(coord) max(((1.0-(coord)&#x2F;_ProjectionParams.y)*_ProjectionParams.z),0)\n    #endif\n#elif UNITY_UV_STARTS_AT_TOP\n    &#x2F;&#x2F;D3d without reversed z &#x3D;&gt; z clip range is [0, far] -&gt; nothing to do\n    #define UNITY_Z_0_FAR_FROM_CLIPSPACE(coord) (coord)\n#else\n    &#x2F;&#x2F;Opengl &#x3D;&gt; z clip range is [-near, far] -&gt; remapping to [0, far]\n    #define UNITY_Z_0_FAR_FROM_CLIPSPACE(coord) max(((coord + _ProjectionParams.y)&#x2F;(_ProjectionParams.z+_ProjectionParams.y))*_ProjectionParams.z, 0)\n#endif</code></pre>\r\n<p>原理是：</p>\r\n<p>虽然OpenGL和D3D在从View Space变化到Clip\r\nSpace中的方式都是类似的，但是实际的值域却有所不同：</p>\r\n<ol type=\"1\">\r\n<li><p>屏幕空间差异：当我们使用 <code>渲染到纹理技术</code> （render\r\nTexture）时，就有可能出现问题，这对应了\r\n<code>UNITY_UV_STARTS_AT_TOP</code> 宏</p>\r\n<figure>\r\n<img\r\nsrc=\"......\\images\\Dev\\Unity\\SourceCodeAnalysis\\URPSourceCode\\003.png\"\r\nalt=\"image-20230409155215810\" />\r\n<figcaption aria-hidden=\"true\">image-20230409155215810</figcaption>\r\n</figure></li>\r\n<li></li>\r\n</ol>\r\n<h4 id=\"section-5\">68~104</h4>\r\n<p>根据宏 <code>UNITY_STEREO_INSTANCING_ENABLED</code> 和宏\r\n<code>UNITY_STEREO_MULTIVIEW_ENABLED</code> 的是否启用，对 TEXTURE\r\n类函数做了兼容层。</p>\r\n<h4 id=\"section-6\">177~190</h4>\r\n<p>定义了两个结构体 <code>VertexPositionInputs</code> 和\r\n<code>VertexNormalnputs</code>，这是两个我们常用的结构体</p>\r\n<h4 id=\"section-7\">193~194</h4>\r\n<p>从 universal 中引入了两个外置文件：</p>\r\n<pre class=\"line-numbers language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\">#include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;ShaderVariablesFunctions.hlsl&quot;\n#include &quot;Packages&#x2F;com.unity.render-pipelines.universal&#x2F;ShaderLibrary&#x2F;Deprecated.hlsl&quot;</code></pre>\r\n<p>让我们先就着 <code>ShaderVariablesFunctions.hlsl</code> 继续</p>\r\n<h2 id=\"reference\">Reference</h2>\r\n<ul>\r\n<li><a\r\nhref=\"https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@12.1/manual/index.html\">Universal\r\nRender Pipeline overview | Universal RP | 12.1.10 (unity3d.com)</a></li>\r\n<li><a\r\nhref=\"https://docs.unity3d.com/2020.1/Documentation/Manual/svt-marking-textures.html\">Unity\r\n- Manual: Marking textures as \"Virtual Texturing Only\"\r\n(unity3d.com)</a></li>\r\n<li><a\r\nhref=\"https://forum.unity.com/threads/feedback-wanted-streaming-virtual-texturing.849133/#:~:text=Streaming%20Virtual%20Texturing%20is%20a%20texture%20streaming%20feature,tiles%20to%20GPU%20memory%20when%20they%20are%20needed.\">Official\r\n- Feedback Wanted: Streaming Virtual Texturing - Unity Forum</a></li>\r\n<li><a\r\nhref=\"https://blog.csdn.net/kan464872327/article/details/108618500\">ShaderLibrary\r\n- DefineSysmbols_装大炮的自行车的博客-CSDN博客</a></li>\r\n</ul>\r\n","text":"URP源码分析 依赖信息： Editor版本：2021.21f1 LTS Shader版本：URP 12.1.10 URP Package总览 首先，当我们下载URP资源时，我们的项目的Package中会出现这些内容： URP资源结构 - com.unity.render-pip...","link":"","photos":[],"count_time":{"symbolsCount":"5.3k","symbolsTime":"5 mins."},"categories":[{"name":"Unity","slug":"Unity","count":17,"path":"api/categories/Unity.json"}],"tags":[{"name":"Unity","slug":"Unity","count":17,"path":"api/tags/Unity.json"},{"name":"Shader","slug":"Shader","count":33,"path":"api/tags/Shader.json"},{"name":"URP","slug":"URP","count":1,"path":"api/tags/URP.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#urp%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90\"><span class=\"toc-text\">URP源码分析</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BE%9D%E8%B5%96%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\">依赖信息：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#urp-package%E6%80%BB%E8%A7%88\"><span class=\"toc-text\">URP Package总览</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%8Ecore.hlsl%E5%BC%80%E5%A7%8B\"><span class=\"toc-text\">从Core.hlsl开始</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%86%E6%9E%90\"><span class=\"toc-text\">分析</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%8F%8A196\"><span class=\"toc-text\">1~2及196</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section\"><span class=\"toc-text\">4~6</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section-1\"><span class=\"toc-text\">8~14</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section-2\"><span class=\"toc-text\">16~19</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section-3\"><span class=\"toc-text\">21~46</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section-4\"><span class=\"toc-text\">49~65</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section-5\"><span class=\"toc-text\">68~104</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section-6\"><span class=\"toc-text\">177~190</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#section-7\"><span class=\"toc-text\">193~194</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#reference\"><span class=\"toc-text\">Reference</span></a></li></ol></li></ol>","author":{"name":"JBR_Bunjie","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/90251718?v=4","link":"/","description":"仿生程序员会在光环上遇见AI乐正绫吗？","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili-fill.svg","link":"https://space.bilibili.com/415377461"},"github":{"icon":"/svg/social_github.svg","link":"https://github.com/JBR-Bunjie"}}}},"mapped":true,"prev_post":{"title":"Custom Right-Click Menu And Shader GUI排列","uid":"a21e0605e124236f924885120b82421a","slug":"Rendering/CustomRightClickMenuAndShaderGUI","date":"2023-04-10T08:32:30.000Z","updated":"2023-10-27T20:19:38.000Z","comments":true,"path":"api/articles/Rendering/CustomRightClickMenuAndShaderGUI.json","keywords":null,"cover":"https://raw.githubusercontent.com/JBR-Bunjie/JBR-Bunjie/main/back.jpg","text":"Custom Right-Click Menu And Shader GUI All the operations in this project should be done in a folder named \"Editor\", no matter where this fo...","link":"","photos":[],"count_time":{"symbolsCount":"15k","symbolsTime":"14 mins."},"categories":[{"name":"Unity","slug":"Unity","count":17,"path":"api/categories/Unity.json"},{"name":"Shader","slug":"Unity/Shader","count":7,"path":"api/categories/Unity/Shader.json"}],"tags":[{"name":"Unity","slug":"Unity","count":17,"path":"api/tags/Unity.json"},{"name":"Shader","slug":"Shader","count":33,"path":"api/tags/Shader.json"}],"author":{"name":"JBR_Bunjie","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/90251718?v=4","link":"/","description":"仿生程序员会在光环上遇见AI乐正绫吗？","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili-fill.svg","link":"https://space.bilibili.com/415377461"},"github":{"icon":"/svg/social_github.svg","link":"https://github.com/JBR-Bunjie"}}}}},"next_post":{"title":"URP Chapter4 - 卡通渲染","uid":"54d190e1f1807867e70fac21b913c281","slug":"Rendering/UpdateToURPPipeline/Chapter4_ToonLit","date":"2023-04-06T13:52:05.000Z","updated":"2023-10-27T20:18:57.000Z","comments":true,"path":"api/articles/Rendering/UpdateToURPPipeline/Chapter4_ToonLit.json","keywords":null,"cover":"https://raw.githubusercontent.com/JBR-Bunjie/JBR-Bunjie/main/back.jpg","text":"Chapter4 - 卡通渲染 上一章我们已经分析了 Unity 内置的 Lit Shader，这是 Unity 在 URP 管线下的默认 Shader 而在这一章，我们将视线转向卡通渲染： Reference kwshh/unity_lit_toonshader (github...","link":"","photos":[],"count_time":{"symbolsCount":157,"symbolsTime":"1 mins."},"categories":[{"name":"Algorithm","slug":"Algorithm","count":31,"path":"api/categories/Algorithm.json"}],"tags":[{"name":"Algorithm","slug":"Algorithm","count":31,"path":"api/tags/Algorithm.json"}],"author":{"name":"JBR_Bunjie","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/90251718?v=4","link":"/","description":"仿生程序员会在光环上遇见AI乐正绫吗？","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili-fill.svg","link":"https://space.bilibili.com/415377461"},"github":{"icon":"/svg/social_github.svg","link":"https://github.com/JBR-Bunjie"}}}}}}